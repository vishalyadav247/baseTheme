{{ 'product-media-gallery.css' | asset_url | stylesheet_tag: preload: true }}

{% liquid
  assign media_layout = section.settings.media_layout

  if media_layout == "slider"
    assign thumbnail_position = section.settings.thumbnail_position
    assign show_media_nav = section.settings.show_media_nav
    assign show_dots = section.settings.show_dots
    assign show_slide_count = section.settings.show_slide_count
    assign loop = section.settings.loop
    assign autoplay = section.settings.autoplay
    assign autoplay_speed = section.settings.autoplay_speed
    assign zoom_style = section.settings.zoom_style
  else
    assign thumbnail_position = "no_thumbnails"
    assign show_media_nav = false
    assign show_dots = false
    assign show_slide_count = false
    assign loop = false
    assign autoplay = false
    assign autoplay_speed = section.settings.autoplay_speed
    assign zoom_style = section.settings.zoom_style
    assign media_grid_count = section.settings.media_grid_count
  endif
%}

{% assign medias = product.media | where: "media_type", "image" %}
{% assign variant = product.selected_or_first_available_variant %}

<div
  class="product-media-wrapper"
  id="product-media-gallery-{{ section.id }}"
  data-autoplay="{{autoplay}}"
  {% if autoplay %}
  data-autoplay-speed="{{ autoplay_speed }}"
  {% endif %}
  data-loop="{{ loop }}"
  data-show-dots="{{ show_dots }}"
  data-show-nav="{{ show_media_nav }}"
  zoom-style="{{zoom_style}}"
  data-layout="{{media_layout}}">
  <div class="product-media" view="{{thumbnail_position}}">

    {% if thumbnail_position != 'no_thumbnails' %}
      <!-- Thumbnails (vertical desktop / horizontal mobile) -->
      <div class="product-media-thumbs">
        <button
          class="product-media-thumbs-nav product-media-thumbs-prev"
          type="button"
          aria-label="Scroll thumbnails up">▲</button>
        <div class="product-media-thumbs-track">

          {% for media in medias %}
            <button
              class="product-media-thumb{% if forloop.first %} is-active{% endif %}"
              type="button"
              data-index="{{ forloop.index0 }}"
              data-media-id="{{ media.id }}"
              aria-label="Thumb {{ forloop.index }}">
              <img
                loading="lazy"
                src="{{ media | img_url: '200x' }}"
                width="100"
                height="100"
                alt="{{ media.alt | escape }}">
            </button>
          {% endfor %}
        </div>
        <button
          class="product-media-thumbs-nav product-media-thumbs-next"
          type="button"
          aria-label="Scroll thumbnails down">▼</button>
      </div>
    {% endif %}
    <!-- Main Slider -->
    <div class="product-media-main">
      {% if show_media_nav %}
        <button
          class="product-media-prev"
          type="button"
          aria-label="Previous slide">‹</button>
      {% endif %}

      <div
        class="product-media-track{% if media_layout == 'grid' %}{% case media_grid_count %}{% when '1' %} grid-cols-1{% when '2' %} grid-cols-2{% when '3' %} grid-cols-3{% endcase %}{% endif %}"
        role="region"
        aria-roledescription="carousel"
        aria-label="Product images">
        {% for media in medias %}
          <div
            class="product-media-slide{% if forloop.first %} is-active{% endif %}"
            data-index="{{ forloop.index0 }}"
            data-media-id="{{ media.id }}">
            <button
              class="product-media-open-lightbox"
              type="button"
              aria-label="Open image {{ forloop.index }} larger">
              <img
                src="{{ media | img_url: '1024x1024' }}"
                srcset="
                  {{ media | img_url: '600x600' }} 600w,
                  {{ media | img_url: '900x900' }} 900w,
                  {{ media | img_url: '1200x1200' }} 1200w"
                sizes="(max-width: 768px) 90vw, 700px"
                alt="{{ media.alt | escape }}"
                draggable="false">
            </button>
          </div>
        {% endfor %}
      </div>

      {% if show_media_nav %}
        <button
          class="product-media-next"
          type="button"
          aria-label="Next slide">›</button>
      {% endif %}

      <div class="product-media-ui">
        {% if show_slide_count %}
          <div class="product-media-counter" aria-live="polite">
            <span class="product-media-current">1</span>/<span class="product-media-total">{{ medias.size }}</span>
          </div>
        {% endif %}

        {% if show_dots %}
          <div
            class="product-media-dots"
            role="tablist"
            aria-label="Slide dots">
            {% for media in medias %}
              <button
                role="tab"
                class="product-media-dot{% if forloop.first %} is-active{% endif %}"
                type="button"
                data-index="{{ forloop.index0 }}"
                aria-label="Go to slide {{ forloop.index }}"></button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if zoom_style == 'popup' %}
    <div
      class="product-media-lightbox"
      hidden
      aria-hidden="true">
      <div class="product-media-lightbox-backdrop"></div>
      <div
        class="product-media-lightbox-content"
        role="dialog"
        aria-modal="true"
        aria-label="Image viewer">
        <button
          class="product-media-lightbox-close"
          type="button"
          aria-label="Close">×</button>
        <button
          class="product-media-lightbox-prev"
          type="button"
          aria-label="Previous">‹</button>
        <figure class="product-media-lightbox-figure">
          <img class="product-media-lightbox-img" alt="">
          <figcaption class="product-media-lightbox-counter">
            <span class="product-media-lightbox-current">1</span>
            <span class="product-media-lightbox-total">
              / {{ medias.size }}</span>
          </figcaption>
        </figure>
        <button
          class="product-media-lightbox-next"
          type="button"
          aria-label="Next">›</button>
      </div>
    </div>
  {% endif %}

  <script src="{{ 'product-media-gallery.js' | asset_url }}" defer></script>

  <script>
        document.addEventListener('shopify:section:load', (e) => {
            const root = e.target?.querySelector?.('[id^="product-media-gallery-"]');
            if (root && window.ProductMediaGallery?.init) window.ProductMediaGallery.init(root);
        });
        document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('product-media-gallery-{{ section.id }}');
            if (root && window.ProductMediaGallery?.init) window.ProductMediaGallery.init(root);
        });
  </script>
</div>